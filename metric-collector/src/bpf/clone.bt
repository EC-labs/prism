#!/home/diogo/.local/bin/bpftrace

tracepoint:syscalls:sys_enter_access
/ pid == $1 /
{
    $filename = str(args->filename);
    if ($filename != "metric-collector-new-pid") {
        return;
    }

    $new_pid = args->mode;
    if (!@pids[$new_pid]) {
        @pids[$new_pid] = 1;
    }
}

tracepoint:syscalls:sys_enter_clone*
/ @pids[pid] / 
{
    @enter[tid] = 1
}

tracepoint:syscalls:sys_exit_clone*
/ @enter[tid] /
{
    printf("%s\t%ld\n", comm, args->ret);
    @enter[tid] = 0;
}
